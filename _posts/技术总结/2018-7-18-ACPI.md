---
layout:     post
title:      ACPI规范解读
category: 技术总结
description: ACPI——ACPI规范解读
tags: ACPI
---

# ACPI规范解读

本文是基于ACPI 6.1规范的解读，详细解释每个章节的含义。帮助读者深入浅出地了解什么是ACPI，ACPI里包括哪些内容，ACPI能够做什么等等。


## 1 引言
ACPI全称为Advanced Configuration and Power Interface，中文意思为高级配置和能源管理接口。通过开发ACPI标准，来建立OS-directed的单板设备配置和能源管理的接口。ACPI是 Operating System-directed configuration and Power Management （OSPM）的关键元素。<br>
ACPI改良了已有的BIOS能源管理代码，APM等。允许Legacy硬件和ACPI硬件共存。<br>
ACPI标准以更有效的方式进一步改良了传统的Plug and Play接口。<br>
标准里的接口和OSPM概念适用于多种硬件设备，OSPM/ACPI提倡让不适用的设备转向低功耗模式。<br>
本文档描述了ACPI硬件接口，ACPI软件接口，用于使能OSPM的ACPI数据结构。<br>

### 1.1 主要目标 
- Enable all computer systems to implement motherboard configuration and power management functions, using appropriate cost/function tradeoffs.
- Enhance power management functionality and robustness.  
- Facilitate and accelerate industry-wide implementation of power management.
- Create a robust interface for configuring motherboard devices.

### 1.2 能源管理说明
把能源管理放到OS里并在OS和硬件之间使用ACPI来实现上面的目标是非常必要的。<br>

### 1.3 Legacy 支持
ACPI提供Legacy硬件到ACPI硬件转换的支持，并运行两者共存。<br>
![](images\2018-7-18-ACPI\101.jpg)<br>

### 1.4 OEM实现策略
ACPI标准的存在，使得有2种通用实现策略可能存在：
* OEM开发OS vendor提供的ACPI OSPM软件，实现ACPI标准的硬件部分。
* OEM开发驱动和不是ACPI兼容的硬件。

### 1.5 Power和Sleep 按键
 OSPM提供一种新的接口给消费者。特殊地，提供一种 “soft” button的sleep按钮来signal OS进入睡眠状态。ACPI定义2种 “soft” button： one for 
putting the machine to sleep and one for putting the machine in soft off.

实现可以是一个按键，或者是2个按键。

### 1.6 ACPI标准和ACPI的结构
![](images\2018-7-18-ACPI\2.jpg)<br>

有3个runtime组件：
- ACPI System Description Tables. 
- ACPI Registers. 
- ACPI Platform Firmware. 

1.7 OS和平台的一致性
ACPI仅仅是接口标准，对平台没有要求。下面是参考实现：
（略）

## 2 术语定义
（略）

## 3 ACPI概述
兼容ACPI标准的平台下，OSPM可以直接和独一无二地进行设备配置和能源管理。在OS初始化时，OSPM接管了这些功能。ACPI提供底层接口，运行OSPM来执行这些功能：<br>
**System power management**<br>
ACPI定义了系统切入和唤醒睡眠状态的机制。<br>
**Device power management**<br>
ACPI表描述设备，和他们的功耗。OS能够将设备置与低功耗。<br>
I**Processor power management**<br>
当OS在idle状态，不在睡眠状态时，会使用ACPI描述的指令将处理器置于低功耗状态。<br>
**Device and processor performance management**<br>
在系统active时，OSPM会转换设备和处理器到不同的性能状态。性能状态运行OSPM在性能和节能之间做权衡。<br>
**Configuration / Plug and Play**<br>
提供OS 设备信息，用于热插拔。<br>
**System Events**<br>
提供事件机制。<br>
**Battery management**<br>
电池管理策略从APM BIOS迁移到ACPI兼容OS。<br>
**Thermal management**<br>
Passive cooling:降功耗来降温。<br>
Active cooling:升功耗来降温。<br>
**Embedded Controller**<br>
**SMBus Controller**<br>

### 3.1 System Power Management<br>

### 3.2 Power States
![](images\2018-7-18-ACPI\3.jpg)<br>
#### 3.2.1 Power Button
#### 3.2.2 Platform Power Management Characteristics
本小节描述各个平台的能源管理特性。（详解SPEC）

### 3.3 Device Power Management
本小节描述ACPI兼容设备能源管理，引入了ACPI设备能源状态。
#### 3.3.1 Device Power Management Model 
三种模型：
- Distributed device power state policy. 
- Layered device power state control. 
- Operating System coordination. 

#### 3.3.2 Power Management Standards
• PCI
• PCI Express
• CardBus
• USB
• IEEE 1394

#### 3.3.3 Device Power States
#### 3.3.4 Device Power State Definitions

### 3.4 Controlling Device Power
ACPI接口提供管理设备功耗的控制方法和信息。OSPM使用这些接口来设置设备的功耗等。

#### 3.4.1 Getting Device Power Capabilities
 Differentiated Definition Block提供给OS设备信息。这些描述包括。<br>
 * 设备支持的每个功耗状态的描述<br>
 * 唤醒机器需要的能耗状态<br>
 * OS用来设置设备能耗状态的可选控制方法<br>
 
#### 3.4.2 Setting Device Power States
对于 power-down操作(transitions from Dx to some deeper Dy),OSPM首先评估_PSx，然后关掉没有用的能耗自由。

#### 3.4.3 Getting Device Power Status 
使用SCI或者GPIO触发事件来通知OS，能耗状态改变了。

#### 3.4.4 Waking the System 
#### 3.4.5 Example: Modem Device Power Management 
### 3.5 Processor Power Management
### 3.6 Device and Processor Performance States 
### 3.7 Configuration and “Plug and Play” 
#### 3.7.1 Device Configuration Example: Configuring the Modem 
#### 3.7.2 NUMA Nodes 
### 3.8 System Events 
### 3.9 Battery Management
### 3.10 Thermal Management
### 3.11 Flexible Platform Architecture Support

## 4 ACPI 硬件标准
ACPI定义了标准接口机制，用于ACPI兼容OS来控制和通信ACPI兼容的硬件。这些接口是可选实现的，但是一旦实现，平台必须遵循ACPI硬件标准。
ACPI定义硬件为可编程模型。ACPI把硬件分成2类：Fixed 或 Generic。落在Fixed里的满足ACPI标准的行为。而通用类的硬件实现就很灵活。
### 4.1 Hardware-Reduced ACPI
有些平台上，ACPI硬件标准不适用。特别地，下面的特性在HW-reduced下不支持：<br>
• GPE block devices are not supported.<br>
• The Global Lock, SMI_CMD, ACPI Enable and ACPI Disable. Hardware-reduced ACPI systems always boot in ACPI mode, and do not support hardware resource sharing between OSPM and other asynchronous operating environments, such as UEFI Runtime Services or 
System Management Mode.<br>
• Bus Master Reload and Arbiter Disable. Systems that depend on OS use of these bits to maintain cache coherency across processor sleep states are not supported.<br>
• GPE block devices are not supported.<br>
支持上面特性的平台，必须遵循ACPI硬件规范。<br>
支持Hardware-reduced ACPI定义的平台必须实现e Fixed ACPI Descriptor Table版本5或者更高版本，必须设置HW_REDUCED_ACPI。

#### 4.1.1 Hardware-Reduced Events
HW-reduced ACPI 平台需要可转换的方法来支持ACPI HW标准里的一些特性。有两个领域需要支持转换：ACPI平台事件模型和 System and Device Wakeup。

##### 4.1.1.1 GPIO-Signaled Events or Interrupt Signaled Events
可以用GPIO硬件来触发平台事件。通过ACPI事件信息命名空间对象（_AEI） 把GPIO映射到ACPI事件处理机制上。 OSPM处理_AE里的GPIO中断像处理SCI一样，执行特定事件相关的事件方法。详见Section 5.6.5。GPIO事件也可作为唤醒事件，设备使用_PRW来管理唤醒事件。<br>
基于中断的事件遵循类似的方法论， 声明generic event device (GED)来描述和事件产生相关的所有中断。中断列在_CRS对象里。当中断asserted, OSPM将会执行事件方法GED对象里的事件方法（_EVT）。中断以这种方式和特定的平台事件绑定。

##### 4.1.1.2 Interrupt-based Wake Events
Wake-capable可以设计为扩展中断或者GPIO中断。

### 4.2 Fixed Hardware Programming Model
因为有从Legacy硬件到fixed硬件转换的需求，ACPI限定了fixed硬件的特性。Fixed硬件有下列标准：<br>
• Performance sensitive features<br>
• Features that drivers require during wake<br>
• Features that enable catastrophic OS software failure recovery<br>
ACPI定义了对fixed硬件的寄存器接口。定义了CPU时钟和能耗管理定时器作为fixed硬件来减少房屋这些硬件的性能影响。
这些逻辑可以落在在PCIe配置空间里。在OS启动之前，OSPM不需要额外的驱动就可以通信。

### 4.3 Generic Hardware Programming Model
Fixed硬件编程模型需要硬件寄存器定义在特定的地址位置，通用硬件编程模型允许硬件寄存器存在大部分的地址空间，提高了灵活度。OSPM之间进入Fixed硬件寄存器，但是访问通用硬件寄存器需要OEM听的ACPI机器语言（AML）来进行。<br>
AML做了以下两件事情：<br>
• Abstracts the hardware from OSPM<br>
• Buffers OEM code from the different OS implementations<br>
为了使能OSPM去执行不同的value added hardware，ACPI定义高层级的控制方法来完成这个任务。
ACPI的另一个目标是为了和OS解耦。<br>
![](images\2018-7-18-ACPI\4.jpg)<br>

以一个IDE HDD硬盘为例，有下列控制方法可以供OSPM调用来控制硬盘的能耗状态：
• _PS0: A control method to sequence the IDE drive to the D0 state.<br>
• _PS3: A control method to sequence the IDE drive to the D3 state.<br>
• _PSC: A control method that returns the status of the IDE drive (on or off).<br>

通用事件特性的例子是平台具有docking能力。Docking是，ACPI事件会生成SCI，OSPM会响应并调用和通用事件关联的事件回调。<br>
AML-code事件回调收集合适的信息然后执行AML Notify命令告知OSPM bus需要重新枚举。

### 4.4 Diagram Legends
硬件章节使用简化的图来表示确切的意思。<br>
![](images\2018-7-18-ACPI\5.jpg)<br>

### 4.5 Register Bit Notation
Registername.Bit

### 4.6 The ACPI Hardware Model
定义了ACPI硬件模型，运行OSPM调度平台在不同的全局系统状态（G0-G3)之间。
 ACPI_ENABLE value to the SMI_CMD 切成ACPI模型。
 ACPI_DISABLE value to the SMI_CMD 切成Legacy模式。

G0工作状态是ACPI系统正常操作状态。OSPM通过编程SLP_TYPx域然后设置SLP_ENx来切换睡眠状态。
![](images\2018-7-18-ACPI\6.jpg)<br>

这个例子描述了支持Legacy和ACPI事件模型的平台。

### 4.7 ACPI Hardware Features
本章节描述ACPI接口定义的不同硬件特征。这些特征分为：
• Fixed Hardware Features
• Generic Hardware Features
![](images\2018-7-18-ACPI\7.jpg)<br>
![](images\2018-7-18-ACPI\8.jpg)<br>

### 4.8 ACPI Register Model
FADT表里包括了fixed hardware register blocks。<br>
寄存器的类型包括：<br>
• Status/Enable Registers (for events)<br>
• Control Registers<br>

![](images\2018-7-18-ACPI\9.jpg)<br>
**Example Generic Devices**
```
// Define a Lid switch
OperationRegion(\PHO, SystemIO, 0x201, 0x1) 
Field(\PHO, ByteAcc, NoLock, Preserve) {
    LPOL, 1                  // Lid polarity control bit
}
Device(\_SB.LID){
     Name(_HID, EISAID(“PNP0C0D”))
     Method(_LID){Return(LPOL)}
     Name(_PRW, Package(2){
         1,                  // bit 1 of GPE to enable Lid wakeup
         0x04}               // can wakeup from S4 state
     )
}
Scope(\_GPE){                // Root level event handlers
    Method(_L01){            // uses bit 1 of GP0_STS register
         Not(LPOL, LPOL)     // Flip the lid polarity bit
         Notify(LID, 0x80)   // Notify OS of event
    }
}
```

## 5 ACPI 软件编程模型
### 5.1 系统描述表架构概述
根系统描述指针（Root System Description Pointer (RSDP) ）由固件建立，存在于系统内存地址空间中。这个地址包括了扩展系统描述表的地址（Extended 
System Description Table (XSDT)），XSDT引用了其他表格的地址，提供了系统的实现与配置。
![](images\2018-7-18-ACPI\10.jpg)<br>

所有的系统描述表用统一的表头开始。系统描述表的主要目的是给OSPM定义不同的工业标准实现细节。这些定义使得硬件实现和设计更为灵活。<br>
XSDT指向内存中的其他表格。第一个指向的，是固定ACPI描述表（Fixed ACPI Description table (FADT)）。这个表中的数据包括了很多固定长度的入口，这些入口描述了很多硬件的固定ACPI特性。FADT表总是指向DSDT，包括了不同系统特性的描述。这些表格的关系如下图所示：<br>
![](images\2018-7-18-ACPI\11.jpg)<br>

FADT的目的是定义与配置、电源管理相关相关的静态系统信息。FADT以FACP签名开头。FADT描述了平台内ACPI硬件寄存器的实现和配置细节。

除了ACPI硬件寄存器实现信息外，FADT也包括了指向DSDT数据结构的物理指针，DSDT包括了定义块格式。

#### 5.1.1 Address Space Translation

### 5.2 ACPI系统描述表（ACPI System Description Tables）
本章节定义了系统描述表的结构：
• Root System Description Pointer (RSDP)<br>
• System Description Table Header<br>
• Root System Description Table (RSDT)<br>
• Fixed ACPI Description Table (FADT)<br>
• Firmware ACPI Control Structure (FACS)<br>
• Differentiated System Description Table (DSDT)<br>
• Secondary System Description Table (SSDT)<br>
• Multiple APIC Description Table (MADT)<br>
• Smart Battery Table (SBST)<br>
• Extended System Description Table (XSDT)<br>
• Embedded Controller Boot Resources Table (ECDT)<br>
• System Locality Distance Information Table (SLIT)<br>
• System Resource Affinity Table (SRAT)<br>
• Corrected Platform Error Polling Table (CPEP)<br>
• Maximum System Characteristics Table (MSCT)<br>
• ACPI RAS FeatureTable (RASF)<br>
• Memory Power StateTable (MPST)<br>
• Platform Memory Topology Table (PMTT)<br>
• Boot Graphics Resource Table (BGRT)<br>
• Firmware Performance Data Table (FPDT)<br>
•  Generic Timer Description Table (GTDT)<br>
• NVDIMM Firmware Interface Table (NFIT)<br>

在ACPI定义的表格，块，结构里的数值总是以小端模式解码。Signature值以固定长度字符串的形式存储。